(function(){"use strict";let T,g,S,k,R;onmessage=function(e){e.data.canvas&&(T=e.data.canvas,D()),e.data.opts&&(g=e.data.opts,D()),e.data.resolvedSeries&&(S=e.data.resolvedSeries,D()),e.data.annotation&&(R=e.data.annotation,D())};function C(e,n){let i=!1;return()=>{i||(i=!0,setTimeout(()=>{i=!1,e()},n))}}let E=0;async function L(){if(!T||!g||!S)return;const{margins:e,canvasWidth:n,canvasHeight:i,visibleStartTimeSec:u,visibleEndTimeSec:p,minValue:s,maxValue:o,zoomInRequired:t}=g;T.width=n,T.height=i;const a=T.getContext("2d");if(!a)return;if(t){a.clearRect(0,0,n,i),a.fillStyle="pink",a.textAlign="center",a.textBaseline="middle",a.font="20px Arial",a.fillText("Zoom in (mouse-wheel) to view data",n/2,i/2);return}E+=1;const d=E;for(const h of k?[1,2]:[1]){if(d!==E)return;const b=Date.now();(h===2||!k)&&(k=M(S));const c=r=>({x:e.left+(r.x-u)/(p-u)*(n-e.left-e.right),y:i-e.bottom-(r.y-s)/(o-s)*(i-e.top-e.bottom)}),y=c({x:0,y:0}).y,v=k.map((r,m)=>({dimensionIndex:m,dimensionLabel:`${m}`,pixelTimes:r.times.map(f=>c({x:f,y:0}).x),pixelValues:r.values.map(f=>c({x:0,y:f}).y),type:r.type,attributes:r.attributes}));I(a,{pixelZero:y,dimensions:v});const l=Date.now()-b;await H(l)}R&&await q({canvasContext:a,canvasWidth:n,canvasHeight:i,visibleStartTimeSec:u,visibleEndTimeSec:p,margins:e,annotation:R})}const D=C(L,10),V=e=>{if(!g||g.hideLegend||!S)return;const{legendOpts:n,margins:i,canvasWidth:u}=g,p=S.filter(y=>y.title);if(p.length===0)return;const{location:s}=n,o=18,t=12,a=50,d=200,h=10,b=20+p.length*o,c=s==="northwest"?{x:i.left+20,y:i.top+20,w:d,h:b}:s==="northeast"?{x:u-i.right-d-20,y:i.top+20,w:d,h:b}:void 0;c&&(e.fillStyle="white",e.strokeStyle="gray",e.lineWidth=1.5,e.fillRect(c.x,c.y,c.w,c.h),e.strokeRect(c.x,c.y,c.w,c.h),p.forEach((y,v)=>{const P=c.y+h+v*o,l={x:c.x+h,y:P,w:a,h:o},r={x:c.x+h+a+h,y:P,w:d-h-h-a-h,h:o},m=y.title||"untitled";if(e.fillStyle="black",e.font=`${t}px Arial`,e.fillText(m,r.x,r.y+r.h/2+t/2),y.type==="line")W(e,y.attributes),e.beginPath(),e.moveTo(l.x,l.y+l.h/2),e.lineTo(l.x+l.w,l.y+l.h/2),e.stroke(),e.setLineDash([]);else if(y.type==="marker"){$(e,y.attributes);const f=o*.3,w=y.attributes.shape??"circle",x={x:l.x+l.w/2,y:l.y+l.h/2};w==="circle"?(e.beginPath(),e.ellipse(x.x,x.y,f,f,0,0,2*Math.PI),e.fill()):w==="square"&&e.fillRect(x.x-f,x.y-f,f*2,f*2)}}))},I=(e,n)=>{if(!g)return;const{margins:i,canvasWidth:u,canvasHeight:p}=g;e.clearRect(0,0,u,p),e.save(),e.beginPath(),e.rect(i.left,i.top,u-i.left-i.right,p-i.top-i.bottom),e.clip(),n.dimensions.forEach(s=>{if(s.type==="line")W(e,s.attributes),e.beginPath(),s.pixelTimes.forEach((o,t)=>{const a=s.pixelValues[t];t===0?e.moveTo(o,a):e.lineTo(o,a)}),e.stroke(),e.setLineDash([]);else if(s.type==="marker"){$(e,s.attributes);const o=s.attributes.radius??2,t=s.attributes.shape??"circle";t==="circle"?s.pixelTimes.forEach((a,d)=>{e.beginPath(),e.ellipse(a,s.pixelValues[d],o,o,0,0,2*Math.PI),e.fill()}):t==="square"&&s.pixelTimes.forEach((a,d)=>{e.fillRect(a-o,s.pixelValues[d]-o,o*2,o*2)})}}),V(e),e.restore()},M=e=>{const n=[];if(!g)return n;const{visibleStartTimeSec:i,visibleEndTimeSec:u}=g;return i===void 0||u===void 0||e.forEach(p=>{const s=p.t,o=p.y;let t=s.flatMap((h,b)=>i<=h&&h<=u?b:[]);(t[0]||0)>0&&(t=[t[0]-1,...t]),(t[t.length-1]||s.length)<s.length-1&&t.push(t[t.length-1]+1);const a=t.map(h=>s[h]),d=t.map(h=>o[h]);n.push({type:p.type,times:a,values:d,attributes:p.attributes})}),n},W=(e,n)=>{e.strokeStyle=n.color??"black",e.lineWidth=n.width??1.1,n.dash&&e.setLineDash(n.dash)},$=(e,n)=>{e.fillStyle=n.color??"black"};function H(e){return new Promise(n=>{setTimeout(n,e)})}let A=0;const q=async e=>{A+=1;const n=A,{canvasContext:i,canvasWidth:u,canvasHeight:p,visibleStartTimeSec:s,visibleEndTimeSec:o,margins:t,annotation:a}=e,{events:d,event_types:h}=a,b=d.filter(l=>l.s<=o&&l.e>=s),c=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255],[255,128,0],[255,0,128],[128,255,0],[0,255,128],[128,0,255],[0,128,255]],y={};for(const l of h){const r=c[l.color_index%c.length];y[l.event_type]=r}let v=Date.now();for(const l of["rect","line"])for(const r of b){if(n!==A)return;const m=y[r.t];if(r.e>r.s){if(l!=="rect")continue;const f={x:t.left+(r.s-s)/(o-s)*(u-t.left-t.right),y:t.top,w:(r.e-r.s)/(o-s)*(u-t.left-t.right),h:p-t.top-t.bottom};i.fillStyle=`rgba(${m[0]},${m[1]},${m[2]},0.3)`,i.fillRect(f.x,f.y,f.w,f.h);const w=Date.now()-v;w>100&&(await P(w),v=Date.now())}else{if(l!=="line")continue;const f={x:t.left+(r.s-s)/(o-s)*(u-t.left-t.right),y:t.top},w={x:f.x,y:p-t.bottom};i.strokeStyle=`rgba(${m[0]},${m[1]},${m[2]},1)`,i.beginPath(),i.moveTo(f.x,f.y),i.lineTo(w.x,w.y),i.stroke()}}function P(l){return new Promise(r=>{setTimeout(r,l)})}}})();
