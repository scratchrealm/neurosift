(function(){"use strict";let T,g,S,k,E;onmessage=function(e){e.data.canvas&&(T=e.data.canvas,D()),e.data.opts&&(g=e.data.opts,D()),e.data.dataSeries&&(S=e.data.dataSeries,D()),e.data.annotation&&(E=e.data.annotation,D())};function C(e,a){let i=!1;return()=>{i||(i=!0,setTimeout(()=>{i=!1,e()},a))}}let A=0;async function I(){if(!T||!g)return;const{margins:e,canvasWidth:a,canvasHeight:i,visibleStartTimeSec:h,visibleEndTimeSec:o,minValue:n,maxValue:l}=g;T.width=a,T.height=i;const t=T.getContext("2d");if(!t)return;A+=1;const p=A;for(const r of k?[1,2]:[1]){if(p!==A)return;const c=Date.now();(r===2||!k)&&(k=S?M(S):void 0);const b=s=>({x:e.left+(s.x-h)/(o-h)*(a-e.left-e.right),y:isNaN(s.y)?NaN:i-e.bottom-(s.y-n)/(l-n)*(i-e.top-e.bottom)}),d=b({x:0,y:0}).y,y=(k||[]).map((s,f)=>({dimensionIndex:f,dimensionLabel:`${f}`,pixelTimes:s.times.map(m=>b({x:m,y:0}).x),pixelValues:s.values.map(m=>b({x:0,y:m}).y),type:s.type,attributes:s.attributes}));V(t,{pixelZero:d,dimensions:y});const v=Date.now()-c;await N(v)}E&&await H({canvasContext:t,canvasWidth:a,canvasHeight:i,visibleStartTimeSec:h,visibleEndTimeSec:o,margins:e,annotation:E})}const D=C(I,10),L=e=>{if(!g||g.hideLegend||!S)return;const{legendOpts:a,margins:i,canvasWidth:h}=g,o=S.filter(y=>y.title);if(o.length===0)return;const{location:n}=a,l=18,t=12,p=50,r=200,c=10,b=20+o.length*l,d=n==="northwest"?{x:i.left+20,y:i.top+20,w:r,h:b}:n==="northeast"?{x:h-i.right-r-20,y:i.top+20,w:r,h:b}:void 0;d&&(e.fillStyle="white",e.strokeStyle="gray",e.lineWidth=1.5,e.fillRect(d.x,d.y,d.w,d.h),e.strokeRect(d.x,d.y,d.w,d.h),o.forEach((y,P)=>{const v=d.y+c+P*l,s={x:d.x+c,y:v,w:p,h:l},f={x:d.x+c+p+c,y:v,w:r-c-c-p-c,h:l},m=y.title||"untitled";if(e.fillStyle="black",e.font=`${t}px Arial`,e.fillText(m,f.x,f.y+f.h/2+t/2),y.type==="line")$(e,y.attributes),e.beginPath(),e.moveTo(s.x,s.y+s.h/2),e.lineTo(s.x+s.w,s.y+s.h/2),e.stroke(),e.setLineDash([]);else if(y.type==="marker"){x(e,y.attributes);const u=l*.3,w=y.attributes.shape??"circle",R={x:s.x+s.w/2,y:s.y+s.h/2};w==="circle"?(e.beginPath(),e.ellipse(R.x,R.y,u,u,0,0,2*Math.PI),e.fill()):w==="square"&&e.fillRect(R.x-u,R.y-u,u*2,u*2)}}))},V=(e,a)=>{if(!g)return;const{margins:i,canvasWidth:h,canvasHeight:o}=g;if(e.clearRect(0,0,h,o),g.zoomInRequired){e.clearRect(0,0,h,o),e.fillStyle="pink",e.textAlign="center",e.textBaseline="middle",e.font="20px Arial",e.fillText("Zoom in (mouse-wheel) to view data",h/2,o/2);return}e.save(),e.beginPath(),e.rect(i.left,i.top,h-i.left-i.right,o-i.top-i.bottom),e.clip(),a.dimensions.forEach(n=>{if(n.type==="line"){$(e,n.attributes),e.beginPath();let l=!0;n.pixelTimes.forEach((t,p)=>{const r=n.pixelValues[p];r===void 0||isNaN(r)?l=!0:(l?e.moveTo(t,r):e.lineTo(t,r),l=!1)}),e.stroke(),e.setLineDash([])}else if(n.type==="marker"){x(e,n.attributes);const l=n.attributes.radius??2,t=n.attributes.shape??"circle";t==="circle"?n.pixelTimes.forEach((p,r)=>{e.beginPath(),e.ellipse(p,n.pixelValues[r],l,l,0,0,2*Math.PI),e.fill()}):t==="square"&&n.pixelTimes.forEach((p,r)=>{e.fillRect(p-l,n.pixelValues[r]-l,l*2,l*2)})}}),L(e),e.restore()},M=e=>{const a=[];if(!g)return a;const{visibleStartTimeSec:i,visibleEndTimeSec:h}=g;return i===void 0||h===void 0||e.forEach(o=>{const n=o.t,l=o.y;let t=n.flatMap((c,b)=>i<=c&&c<=h?b:[]);(t[0]||0)>0&&(t=[t[0]-1,...t]),(t[t.length-1]||n.length)<n.length-1&&t.push(t[t.length-1]+1);const p=t.map(c=>n[c]),r=t.map(c=>l[c]);a.push({type:o.type,times:p,values:r,attributes:o.attributes})}),a},$=(e,a)=>{e.strokeStyle=a.color??"black",e.lineWidth=a.width??1.1,a.dash&&e.setLineDash(a.dash)},x=(e,a)=>{e.fillStyle=a.color??"black"};function N(e){return new Promise(a=>{setTimeout(a,e)})}let W=0;const H=async e=>{W+=1;const a=W,{canvasContext:i,canvasWidth:h,canvasHeight:o,visibleStartTimeSec:n,visibleEndTimeSec:l,margins:t,annotation:p}=e,{events:r,event_types:c}=p,b=r.filter(s=>s.s<=l&&s.e>=n),d=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255],[255,128,0],[255,0,128],[128,255,0],[0,255,128],[128,0,255],[0,128,255]],y={};for(const s of c){const f=d[s.color_index%d.length];y[s.event_type]=f}let P=Date.now();for(const s of["rect","line"])for(const f of b){if(a!==W)return;const m=y[f.t];if(f.e>f.s){if(s!=="rect")continue;const u={x:t.left+(f.s-n)/(l-n)*(h-t.left-t.right),y:t.top,w:(f.e-f.s)/(l-n)*(h-t.left-t.right),h:o-t.top-t.bottom};i.fillStyle=`rgba(${m[0]},${m[1]},${m[2]},0.3)`,i.fillRect(u.x,u.y,u.w,u.h);const w=Date.now()-P;w>100&&(await v(w),P=Date.now())}else{if(s!=="line")continue;const u={x:t.left+(f.s-n)/(l-n)*(h-t.left-t.right),y:t.top},w={x:u.x,y:o-t.bottom};i.strokeStyle=`rgba(${m[0]},${m[1]},${m[2]},1)`,i.beginPath(),i.moveTo(u.x,u.y),i.lineTo(w.x,w.y),i.stroke()}}function v(s){return new Promise(f=>{setTimeout(f,s)})}}})();
