(function(){"use strict";let T,m,S,D,R;onmessage=function(e){e.data.canvas&&(T=e.data.canvas,k()),e.data.opts&&(m=e.data.opts,k()),e.data.resolvedSeries&&(S=e.data.resolvedSeries,k()),e.data.annotation&&(R=e.data.annotation,k())};function L(e,a){let i=!1;return()=>{i||(i=!0,setTimeout(()=>{i=!1,e()},a))}}let x=0;async function V(){if(!T||!m||!S)return;const{margins:e,canvasWidth:a,canvasHeight:i,visibleStartTimeSec:p,visibleEndTimeSec:c,minValue:s,maxValue:o}=m;T.width=a,T.height=i;const t=T.getContext("2d");if(!t)return;x+=1;const h=x;for(const d of D?[1,2]:[1]){if(h!==x)return;const l=Date.now();(d===2||!D)&&(D=H(S));const b=n=>({x:e.left+(n.x-p)/(c-p)*(a-e.left-e.right),y:i-e.bottom-(n.y-s)/(o-s)*(i-e.top-e.bottom)}),f=b({x:0,y:0}).y,y=D.map((n,r)=>({dimensionIndex:r,dimensionLabel:`${r}`,pixelTimes:n.times.map(g=>b({x:g,y:0}).x),pixelValues:n.values.map(g=>b({x:0,y:g}).y),type:n.type,attributes:n.attributes}));M(t,{pixelZero:f,dimensions:y});const w=Date.now()-l;await I(w)}R&&await F({canvasContext:t,canvasWidth:a,canvasHeight:i,visibleStartTimeSec:p,visibleEndTimeSec:c,margins:e,annotation:R})}const k=L(V,10),A=e=>{if(!m||m.hideLegend||!S)return;const{legendOpts:a,margins:i,canvasWidth:p}=m,c=S.filter(y=>y.title);if(c.length===0)return;const{location:s}=a,o=18,t=12,h=50,d=200,l=10,b=20+c.length*o,f=s==="northwest"?{x:i.left+20,y:i.top+20,w:d,h:b}:s==="northeast"?{x:p-i.right-d-20,y:i.top+20,w:d,h:b}:void 0;f&&(e.fillStyle="white",e.strokeStyle="gray",e.lineWidth=1.5,e.fillRect(f.x,f.y,f.w,f.h),e.strokeRect(f.x,f.y,f.w,f.h),c.forEach((y,P)=>{const w=f.y+l+P*o,n={x:f.x+l,y:w,w:h,h:o},r={x:f.x+l+h+l,y:w,w:d-l-l-h-l,h:o},g=y.title||"untitled";if(e.fillStyle="black",e.font=`${t}px Arial`,e.fillText(g,r.x,r.y+r.h/2+t/2),y.type==="line")$(e,y.attributes),e.beginPath(),e.moveTo(n.x,n.y+n.h/2),e.lineTo(n.x+n.w,n.y+n.h/2),e.stroke(),e.setLineDash([]);else if(y.type==="marker"){C(e,y.attributes);const u=o*.3,v=y.attributes.shape??"circle",E={x:n.x+n.w/2,y:n.y+n.h/2};v==="circle"?(e.beginPath(),e.ellipse(E.x,E.y,u,u,0,0,2*Math.PI),e.fill()):v==="square"&&e.fillRect(E.x-u,E.y-u,u*2,u*2)}}))},M=(e,a)=>{if(!m)return;const{margins:i,canvasWidth:p,canvasHeight:c}=m;e.clearRect(0,0,p,c),e.save(),e.beginPath(),e.rect(i.left,i.top,p-i.left-i.right,c-i.top-i.bottom),e.clip(),a.dimensions.forEach(s=>{if(s.type==="line")$(e,s.attributes),e.beginPath(),s.pixelTimes.forEach((o,t)=>{const h=s.pixelValues[t];t===0?e.moveTo(o,h):e.lineTo(o,h)}),e.stroke(),e.setLineDash([]);else if(s.type==="marker"){C(e,s.attributes);const o=s.attributes.radius??2,t=s.attributes.shape??"circle";t==="circle"?s.pixelTimes.forEach((h,d)=>{e.beginPath(),e.ellipse(h,s.pixelValues[d],o,o,0,0,2*Math.PI),e.fill()}):t==="square"&&s.pixelTimes.forEach((h,d)=>{e.fillRect(h-o,s.pixelValues[d]-o,o*2,o*2)})}}),A(e),e.restore()},H=e=>{const a=[];if(!m)return a;const{visibleStartTimeSec:i,visibleEndTimeSec:p}=m;return i===void 0||p===void 0||e.forEach(c=>{const s=c.t,o=c.y;let t=s.flatMap((l,b)=>i<=l&&l<=p?b:[]);(t[0]||0)>0&&(t=[t[0]-1,...t]),(t[t.length-1]||s.length)<s.length-1&&t.push(t[t.length-1]+1);const h=t.map(l=>s[l]),d=t.map(l=>o[l]);a.push({type:c.type,times:h,values:d,attributes:c.attributes})}),a},$=(e,a)=>{e.strokeStyle=a.color??"black",e.lineWidth=a.width??1.1,a.dash&&e.setLineDash(a.dash)},C=(e,a)=>{e.fillStyle=a.color??"black"};function I(e){return new Promise(a=>{setTimeout(a,e)})}let W=0;const F=async e=>{W+=1;const a=W,{canvasContext:i,canvasWidth:p,canvasHeight:c,visibleStartTimeSec:s,visibleEndTimeSec:o,margins:t,annotation:h}=e,{events:d,event_types:l}=h,b=d.filter(n=>n.s<=o&&n.e>=s),f=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255],[255,128,0],[255,0,128],[128,255,0],[0,255,128],[128,0,255],[0,128,255]],y={};for(const n of l){const r=f[n.color_index%f.length];y[n.event_type]=r}let P=Date.now();for(const n of["rect","line"])for(const r of b){if(a!==W)return;const g=y[r.t];if(r.e>r.s){if(n!=="rect")continue;const u={x:t.left+(r.s-s)/(o-s)*(p-t.left-t.right),y:t.top,w:(r.e-r.s)/(o-s)*(p-t.left-t.right),h:c-t.top-t.bottom};i.fillStyle=`rgba(${g[0]},${g[1]},${g[2]},0.3)`,i.fillRect(u.x,u.y,u.w,u.h);const v=Date.now()-P;v>100&&(await w(v),P=Date.now())}else{if(n!=="line")continue;const u={x:t.left+(r.s-s)/(o-s)*(p-t.left-t.right),y:t.top},v={x:u.x,y:c-t.bottom};i.strokeStyle=`rgba(${g[0]},${g[1]},${g[2]},1)`,i.beginPath(),i.moveTo(u.x,u.y),i.lineTo(v.x,v.y),i.stroke()}}function w(n){return new Promise(r=>{setTimeout(r,n)})}}})();
